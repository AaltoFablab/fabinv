<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Inventory</title>
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/png" href="images/icon2.png">
  </head>
  <body>
    <div class="container" id="zero">
      <div id="header">
        <h3 class="u-full-width" id="headerone" style="color:#1c20ff;">
          Inventory
        </h3>
      </div>
      <br />
      <div class="five columns" id="search-box">
        <input type="text" name="search" autocomplete="off" id="search" placeholder="Search For Items..."/>
      </div>
      <div class="seven columns" id="tool-pane">
        <ul>
          <li class="btn-add">[new entry]</li>
          <li style="margin-left:30px" class="btn-add-dbg">[dbg entry]</li>
        </ul>
      </div>
      <br />
      <br />
      <br />
      <div class="row" id="one">
        <div class="seven columns" id="two">
          <table class="u-full-width" id="items-table">
            <p id="titled">
              Name, Price (â‚¬), Location
            </p>
            <tbody>
            </tbody>
          </table>
        </div>
        <div class="five columns" id="three">
          <div id="detail-pane">
            <h3 id="headertwo" style="color:red">
              Details
            </h3>
            <p id="detailtext">
              Click on items for details.
            </p>
            <!--Edit Button not functional, can be removed-->
            <button class="btn-edit u-full-width" style="float:left">Edit details</button>
            <!-- !!!!!!! -->
            <button class="btn-delete u-full-width" style="float:right">Delete entry</button>
          </div>
        </div>
      </div>
    </div>
    <!--- Change pathing --->                             <!-------->
    <script src="libraries/jquery-3.4.1.min.js"></script>
    <script>
      var clickID;
      var clickName;

      function editDetailsForm(itemName, itemID) {
        $('#detailtext').html(
        'EDIT DETAILS <br />' +
        'Edit details for ' + clickName + '<br />' +
        '<input class="ev" id="inpName" placeholder="item name">' +
        '<input class="ev" id="inpPrice" placeholder="item price">' +
        '<select id="inpLocation" > <option value="5d1c7a5c21208eb5d689d273">Assembly Room</option> ' +
        '<option value="5d1c7a5c21208eb5d689d274">Electronics</option> ' +
        '<option value="5d1c7a5c21208eb5d689d272">Storage Room</option> </select>' +
        '<br />' +
        '<button id="edit-item-button">edit details</button>');
         console.log(itemName);
         console.log(itemID);
         $('#edit-item-button').click(function() {
           editDetails();
         });
      }
      function editDetails() {
        var inpName = $('#inpName').val();
        var inpPrice = Number.parseFloat($('#inpPrice').val()).toFixed(2);
        var inpLocation = $('#inpLocation option:selected').val();
        console.log(inpName);
        console.log(inpPrice);
        console.log(inpLocation);

        $.ajax({
          type: 'POST',
          url:"/graphql",
          contentType: "application/graphql",
          data: 'mutation{updateItem(' +
          'id: "' + clickID + '"' +
          'locationId: "' + inpLocation + '", ' +
          'name: "' + inpName + '"' +
          'price:' + inpPrice + '){ok}}',

          success:function(data){
            console.log(data);
            var term = $('#search').val();
            search(term);
            $('#detailtext').html(
            'Item Edited.');
          },
          error:function(data){
            console.log(data);
          }
        });
      }
      function confirmDelete(itemName, itemID) {

        $('#detailtext').html(
        '<span id="confirmtxt">Confirm item deletion for </span> <br /> <span  id="itmtxt">' + itemName +
        '</span><br /><br />' +
        '<button class="slct" id="confirmDlt">[CONFIRM]</button>');

        $('#confirmDlt').click(function() {
          deleteItem(itemID);
          console.log(itemID);

          $('#detailtext').html(
          'Item Deleted.');
        });
      }
      function deleteItem(itemID) {
        var term = $('#search').val();
        $.ajax({
          type: 'POST',
          url:"/graphql",
          contentType: "application/graphql",
          data: 'mutation{removeItem(id:"' + itemID + '"){ok}}',

          success:function(data){
            console.log(data);
            search(term);
          },
          error:function(data){
            console.log(data);
          }
        });
      }
      function addDebug() {
        var x = Math.floor((Math.random() * 89) + 10);
        var y = Math.floor((Math.random() * 89) + 10);
        var z = Math.floor((Math.random() * 89) + 10);

        $.ajax({
          type: 'POST',
          url:"/graphql",
          contentType: "application/graphql",
          data: 'mutation{addItem(locationId:"5d1c7a5c21208eb5d689d274", name:"' + "dbgitem " + x +" "+ y +" "+ z + '", price:1){item{name}}}',

          success:function(data){
            var term = $('#search').val();
            search(term);

            $('#detailtext').html(
            'Item Added.');
          },

          error:function(data){
            console.log(data);
          }
        });
      }
      function addItemForm() {
        $('#detailtext').html(
          'ADD NEW ITEM' +
          '<br />' +
          '<input class="ev" id="inpName" placeholder="item name">' +
          '<input class="ev" id="inpPrice" placeholder="item price">' +
          '<select id="inpLocation" > <option value="5d1c7a5c21208eb5d689d273">Assembly Room</option> ' +
          '<option value="5d1c7a5c21208eb5d689d274">Electronics</option> ' +
          '<option value="5d1c7a5c21208eb5d689d272">Storage Room</option> </select>' +
          '<br />' +
          '<button id="add-item-button">add item</button>');

            $('#add-item-button').click(function() {
              addItem();
            });
      }
      function addItem() {  //\\//\\\//\\//\\//\\\//\\//\\//\\\//\\
        var inpName = $('#inpName').val();
        //
        var inpPrice = Number.parseFloat($('#inpPrice').val()).toFixed(2);
        //
        var inpLocation = $('#inpLocation option:selected').val();
        console.log('testNum: ', inpPrice);
        $.ajax({
          type: 'POST',
          url:"/graphql",
          contentType: "application/graphql",
          data: 'mutation{addItem(locationId:"' + inpLocation + '",' +
          ' name:"' + inpName + '",' +
          ' price:' + inpPrice + '){item{name}}}',

          success:function(data){
            console.log(data);
            var term = $('#search').val();
            search(term);
            $('#detailtext').html(
            'Item Added.');
          },
          error:function(data){
            console.log(data);
          }
        });
      }
      function search(term) {
        $.ajax({

          type: 'POST',
          url:"/graphql",
          contentType: "application/graphql",
          data: '{items(search:"' + term + '"){id,name,price,location{name}}}',

          success: function(result) {

            $("#items-table").empty();

            console.log(result);
            let items = result.data.items;
            for(var i = 0; i < items.length; i++) {

              console.log(items[i]);

              $("#items-table").append(   //\\//\\SET//\\ITEM//\\TABLE//\\//\\

                '<tr data-id="' + items[i].id + '">' +
                '<td class="itemName">' + items[i].name + '</td>' +
                '<td class="itemPrice">' + items[i].price + '</td>' +
                '<td class="itemLocationName">' + items[i].location.name + '</td>' +
                '</tr>');

              $('#items-table tr').last().click(function(){

                var itemName = $(this).find('.itemName').first().text();
                var itemPrice = $(this).find('.itemPrice').first().text();
                var itemLocationName = $(this).find('.itemLocationName').first().text();
                var itemID = $(this).data('id');
                clickID = itemID;
                clickName = itemName;
                console.log( itemName, itemPrice, itemLocationName, itemID);

                $('#detailtext').html(

                  'Item Name: ' + itemName + '<br><br>' +
                  'Item Price: ' + itemPrice + '<br><br>' +
                  'Item Location: ' + itemLocationName );

                $('#detail-pane .btn-delete').unbind('click');
                $('#detail-pane .btn-delete').click(function() {
                  console.log(itemName, itemPrice, itemLocationName);
                  confirmDelete(itemName, itemID);

                  console.log(term);
                });
              });
            }
          }
        });
      }
      $(document).ready (function() {
        search('');

        var itemName = $(this).find('.itemName').first().text();
        var itemID = $(this).data('id');

        $('#tool-pane .btn-add-dbg').click(function() {
          addDebug();
          console.log('button add debug clicked');
        });
        $('#tool-pane .btn-add').click(function() {
          addItemForm();
        });
        $('.btn-edit').click(function(){
          editDetailsForm(itemName, itemID);
        });
        $('#search').bind('input propertyChange', function(event) {
          console.log(event.target.value);
          search(event.target.value);
        });
      });
    </script>
  </body>
</html>
